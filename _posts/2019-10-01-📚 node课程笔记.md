---
layout: post
title: ğŸ“š nodeè¯¾ç¨‹ç¬”è®°
img: header_post.jpg
tags: [node, ts, js, ğŸ“š]
---

- [node](#node)
  - [ç®€å• web æœåŠ¡å™¨](#ç®€å•-web-æœåŠ¡å™¨)
  - [è¿æ¥ mongodb](#è¿æ¥-mongodb)
  - [promise](#promise)
  - [nodemon å’Œ pm2](#nodemon-å’Œ-pm2)
  - [whistle](#whistle)
- [ts](#ts)
  - [å˜é‡ å¸¸é‡ æšä¸¾ è”åˆ](#å˜é‡-å¸¸é‡-æšä¸¾-è”åˆ)
  - [node ç¬¬ä¸‰æ–¹åº“](#node-ç¬¬ä¸‰æ–¹åº“)
  - [æ–¹æ³•](#æ–¹æ³•)
- [js](#js)
  - [æ–¹æ³•](#æ–¹æ³•-1)
  - [å¯¹è±¡ ç±»](#å¯¹è±¡-ç±»)
  - [æ•°ç»„å¾ªç¯(for...in) è¿­ä»£(for...of)](#æ•°ç»„å¾ªç¯forin-è¿­ä»£forof)
  - [æ¨¡å—](#æ¨¡å—)
  - [å…¶ä»–](#å…¶ä»–)
    - [è¿›åˆ¶è½¬æ¢](#è¿›åˆ¶è½¬æ¢)
    - [æ–‡å­—æ¨¡ç‰ˆ](#æ–‡å­—æ¨¡ç‰ˆ)
    - [symbol()](#symbol)
    - [å‡½æ•°æ„é€ å™¨](#å‡½æ•°æ„é€ å™¨)
    - [åŠ¨æ€ç»‘å®šå±æ€§](#åŠ¨æ€ç»‘å®šå±æ€§)
    - [å‡½æ•°çš„è°ƒç”¨å †æ ˆ](#å‡½æ•°çš„è°ƒç”¨å †æ ˆ)
    - [void æ— æ•ˆæ“ä½œç¬¦](#void-æ— æ•ˆæ“ä½œç¬¦)

---

# node

- ç®€å• web æœåŠ¡å™¨
- è¿æ¥ mongodb
- promise
- nodemon å’Œ pm2
- whistle

## ç®€å• web æœåŠ¡å™¨

```js
// config.js æ–‡ä»¶
const config = {
  hostname: "127.0.0.1",
  port: "3000",
};
exports.config = config;

// myserver.js æ–‡ä»¶
const config = require("./config").config; // å¼•ç”¨ config.js æ–‡ä»¶
const http = require("http"); // nodejs å†…ç½® http æ¨¡å—
const fs = require("fs"); // nodejs å†…ç½® fs æ–‡ä»¶è¯»å†™æ¨¡å—
const qs = require("querystring"); // nodejs å†…ç½® qs æŸ¥è¯¢ä¸²æ¨¡å—
const ejs = require("ejs"); // ejs æ¨¡æ¿å®ç°è¡¨å•é¡µé¢ï¼Œå®‰è£… npm install ejs

var template = fs.readFileSync(__dirname + "/forum.ejs", "utf-8"); // è¯» ejs æ–‡ä»¶
var posts = [];
const hostname = "127.0.0.1"; // å¦‚æ—  config.js æ–‡ä»¶åˆ™ç»Ÿä¸€é…ç½®
const port = 3000;

const server = http.createServer((req, res) => {
  res.statusCode = 200;
  res.setHeader("Content-Type", "text/plain");

  switch (
    req.url // req.url è¿”å›å®¢æˆ·ç«¯è¯·æ±‚çš„ url
  ) {
    case "/":
      res.end("helo world.");
      break;
    case "/home":
      res.end("Welcome to my homepage!");
      break;
    default:
      res.end("NotFound!");
  }

  // è¯» html æ–‡ä»¶å¹¶è¿”å›
  fs.readFile(__dirname + "/index.html", "utf-8", function (err, data) {
    if (err) {
      res.setHeader("Content-Type", "text/plain");
      res.statusCode = 404;
      res.end("Not Founded.");
    } else {
      res.setHeader("Content-Type", "text/html");
      res.statusCode = 200;
      res.end(data);
    }
  });

  // è¡¨å•æäº¤
  if (req.method === "POST") {
    req.data = "";
    // è¡¨å•æ•°æ®æ”¶é›†
    req.on("readable", function () {
      var chr = req.read();
      if (chr) req.data += chr;
    });
    // è¡¨å•å¤„ç†
    req.on("end", function () {
      var query = qs.parse(req.data);
      posts.push(query.content);
      showForm(posts, res); // è¡¨å•æ˜¾ç¤º
    });
  } else showForm(posts, res);
});

function showForm(p_posts, res) {
  var data = ejs.render(template, { posts: p_posts }); // ejs ç€è‰²
  res.setHeader("Content-Type", "text/html");
  res.statusCode = 200;
  res.end(data);
}

// æ‰“å¼€ç›‘å¬
server.listen(config.port, config.hostname, () => {
  console.log("Server running at http://${config.hostname}:${config.port}/");
});
```

```html
<!-- forum.ejs æ–‡ä»¶-->
<form action="" method="post">
  <!-- action="" å‘è‡ªèº«æäº¤ -->
  <input type="text" name="content" id="content" />
  <input type="submit" value="æäº¤" />
  <ul>
    <!-- <% for (var i = 0; i < posts.length; i++) { %>
        <li><%= posts[i] %></li>
        <% } %> -->
  </ul>
</form>
```

## è¿æ¥ mongodb

```js
// mongofunc.js æ–‡ä»¶ï¼Œå®‰è£… npm install mongodb [--save]ï¼Œè‡ªåŠ¨ç”Ÿæˆ mongofunc.js æ–‡ä»¶
const MongoClient = require("mongodb").MongoClient; // mongodb å®¢æˆ·ç«¯
const assert = require("assert"); // nodejs å†…ç½® assert æ–­è¨€æ¨¡å—

const url = "mongodb://192.168.11.18:27017";
const dbName = "komablog";

MongoClient.connect(url, function (err, client) {
  assert.equal(null, err);
  console.log("Connected successfully to server");
  const db = client.db(dbName); // æ‰“å¼€æ•°æ®åº“

  db.collection("posts", function (err, collection) {
    var list = [
      { title: "æˆ‘çˆ±ç©é©¬é‡Œå¥¥", tag: "game" },
      { title: "æˆ‘å–œæ¬¢Nodejsç¼–ç¨‹", tag: "it" },
    ];
    // æ’å…¥ MongoDB æ–‡æ¡£
    collection.insert(list, function (err, result) {
      assert.equal(null, err);
      client.close();
    });
    // è¯» MongoDB æ–‡æ¡£
    collection.find({ tag: "game" }).toArray(function (err, docs) {
      assert.equal(null, err);
      console.log(docs);
      client.close();
    });
  });
});
```

## promise

```js
function dbupd(sql, done) {
  setTimeout(() => done(sql + " upd ok."), 800);
}

// å›è°ƒåœ°ç‹±
dbupd("1.sql1", (result) => {
  console.log(result);
  dbupd("2.sql2", (result) => {
    console.log(result);
    dbupd("3.sql3", (result) => {
      console.log(result);
    });
  });
});

function dbupAsync(sql) {
  // Promise å¼‚æ­¥æ–¹æ³•
  // æˆåŠŸè°ƒç”¨ resolve()ï¼Œå¤±è´¥è°ƒç”¨ reject()
  const p = new Promise((resolve, reject) => {
    setTimeout(() => {
      console.log(sql + " upd ok.");
      resolve(sql + ".ok");
    }, 800);
  });
  return p;
}
// Promise ç±»(p å¸¸é‡).then() å¯è°ƒç”¨ Promise å¼‚æ­¥æ–¹æ³•
dbupAsync("1.sql1")
  .then(() => dbupAsync("2.sql2"))
  .then(() => dbupAsync("3.sql3"));

// async/await å¯è°ƒç”¨ Promise å¼‚æ­¥æ–¹æ³•
async function upAllDB() {
  const result1 = await dbupAsync("1.sql1");
  const result2 = await dbupAsync("2.sql2");
  const result3 = await dbupAsync("3.sql3");
  console.log(result1, result2, result3);
}
upAllDB();
```

## nodemon å’Œ pm2

```bash
$ sudo npm install nodemon -g # çƒ­æ›´æ–° nodeï¼Œnodemon server.js
$ sudo npm install pm2 -g # ç›‘æ§ nodeï¼Œç”Ÿäº§ç¯å¢ƒæœåŠ¡å™¨éƒ¨ç½²ï¼Œpm2 start server.js

$ pm2 list
$ pm2 stop/restart/reload/delete 0 # 0 ä¸ºè¿›ç¨‹å·ï¼Œå¯æ¢è¿›ç¨‹å
$ pm2 start server-pm2.json # server-pm2.json æ–‡ä»¶ä¸º pm2 é…ç½®ï¼Œå†…å®¹å¦‚ä¸‹
```

```json
{
  "name": "myweb",
  "script": "server.js",
  "port": 8080,
  "env": { "NODE_ENV": "production" },
  "options": [""]
}
```

## whistle

```bash
$ sudo npm install whistle -g
$ w2 help/start/restart/stop # éœ€ä¸‹è½½ https è¯ä¹¦
```

# ts

- é»˜è®¤
- å˜é‡ å¸¸é‡ æšä¸¾ è”åˆ
- node ç¬¬ä¸‰æ–¹åº“
- æ–¹æ³•

```bash
$ npm install -g typescript
$ tsc -v
$ tsc heloworld.ts # ä»£ç ç¼–è¯‘
$ tsc --outDir dist ./src/heloworld.ts # æŒ‡å®šè¾“å‡ºç›®å½•
$ tsc --init # åˆå§‹åŒ– tsconfig.json æ–‡ä»¶ï¼Œåœ¨ tsconfig.json æ–‡ä»¶ä¸­å¯é…ç½® outDir ä½ç½®å’Œ rootDir ä½ç½®ï¼Œå‘½ä»¤ tsc å¯ç¼–è¯‘
$ tsc -w # åŠ¨æ€ç›‘è§†
```

## å˜é‡ å¸¸é‡ æšä¸¾ è”åˆ

- `number` æ•°å€¼
- `string` å­—ç¬¦ä¸²
- `boolean` å¸ƒå°”
- `symbol` ç¬¦å·ï¼Œæ ‡è¯†å”¯ä¸€å¯¹è±¡
- `any` ä»»æ„
- `object` å¯¹è±¡ï¼Œæ•°ç»„ã€å…ƒç»„ã€ç±»ã€æ¥å£ã€æ–¹æ³•ç­‰
- `type[]` æ•°ç»„

```ts
// let å˜é‡å: ç±»å‹ = é»˜è®¤å€¼;
// const å¸¸é‡å: ç±»å‹ = å¸¸é‡å€¼;

// æšä¸¾
enum Sex {
  MALE,
  FEMALE,
  UNKNOWN,
}
let member_sex: Sex = Sex.FEMALE;
console.log(member_sex); // 1
console.log(Sex[member_sex]); // FEMALE
console.log(checkSex(member_sex));

// æšä¸¾ä½¿ç”¨ 1
switch (+member_sex) {
  case Sex.MALE:
    console.log("ç”·");
    break;
  case Sex.FEMALE:
    console.log("å¥³");
    break;
  case Sex.UNKNOWN:
    console.log("ä¸æ˜");
    break;
}

// æšä¸¾ä½¿ç”¨ 2
function checkSex(sex: Sex) {
  let result: string = "";
  switch (sex) {
    case Sex.MALE:
      result = "ç”·";
      break;
    case Sex.FEMALE:
      result = "å¥³";
      break;
    case Sex.UNKNOWN:
      result = "ä¸æ˜";
      break;
  }
  return result;
}

// è”åˆ
let mydata: string | boolean;
mydata = "Helo TS!";
mydata = true;
```

## node ç¬¬ä¸‰æ–¹åº“

- node-request åº“åœ¨ `.js` æ–‡ä»¶ä¸­ä½¿ç”¨

```bash
$ npm init
$ npm install --save request
$ node main.js
```

```js
// main.jsæ–‡ä»¶
const request = require("request");
request("http://api.komavideo.com/news/list", function (error, response, body) {
  if (error) console.error(error);
  else console.log(body);
});
```

- node ç¬¬ä¸‰æ–¹åº“åœ¨ `.ts` æ–‡ä»¶ä¸­ä½¿ç”¨
  - åœ¨ `https://microsoft.github.io/TypeSearch` å¯¼å…¥ç›¸å…³ `tsd` åº“
  - åœ¨ `.ts` æ–‡ä»¶ä¸­è°ƒç”¨ï¼ŒæŠŠ `const request = require('request');` æ›¿æ¢æˆ `import request = require('request');`

```bash
$ npm install --save @types/request
$ tsc test.ts
$ node test.js
```

## æ–¹æ³•

```ts
// ç®­å¤´æ–¹æ³•
let func_add2 = (x: number, y: number): number => {
  return x + y;
};

// ? ä¸ºå¯çœç•¥å‚æ•°
function sayHelo(name?: string): string {
  if (name === undefined) return "Helo Koma.";
  else return "Helo " + name + ".";
}

// æ•°ç»„å®ç°å¯å˜é•¿å‚æ•°ï¼Œæˆ– function add(...vals:number[]): number{}ï¼Œè°ƒç”¨æ–¹æ³• add(1,2,3)
function add(vals: number[]): number {
  let result = 0;
  for (let val of vals) result += val;
  return result;
}
console.log(add1([1, 2, 3]));
```

# js

- æ–¹æ³•
- å¯¹è±¡ ç±»
- æ•°ç»„å¾ªç¯(for...in) è¿­ä»£(for...of)
- æ¨¡å—
- å…¶ä»–
  - è¿›åˆ¶è½¬æ¢
  - æ–‡å­—æ¨¡ç‰ˆ
  - symbol()
  - å‡½æ•°æ„é€ å™¨
  - åŠ¨æ€ç»‘å®šå±æ€§
  - å‡½æ•°çš„è°ƒç”¨å †æ ˆ
  - void æ— æ•ˆæ“ä½œç¬¦

## æ–¹æ³•

```js
// å¿…é¡»æŒ‡å®šå‚æ•°
function required() {
  throw new Error("å‚æ•°æœªæŒ‡å®š");
}
function sayBye(name = required()) {
  console.log("${name} bye!");
}
sayBye("Koma"); // sayBye() æŠ¥é”™'å‚æ•°æœªæŒ‡å®š'

// å¯å˜é•¿å‚æ•°
function sum(...args) {
  let result = 0;
  args.forEach((val) => {
    result += val;
  });
  return result;
}
console.log(sum(1, 2, 3, 4, 5, 6, 7, 8, 9, 10));

let list = [10, 20, 30];
// ES5 å†™æ³•
let newlist = list.map(function (value, index) {
  return value * value;
});
// ES6 å†™æ³•ï¼Œç®­å¤´æ–¹æ³•
newlist = list.map((value) => {
  return value * value;
});
```

## å¯¹è±¡ ç±»

```js
let title = "ES6ä»å…¥é—¨åˆ°å­¦ä¼š";
let price = 25;
// å¯¹è±¡å®šä¹‰
let book = {
  title,
  price,
  toString() {
    console.log("<<${this.title}>> ${price}å…ƒ");
  },
};
book["lang"] = "ç®€ä½“ä¸­æ–‡";

// ç±»å®šä¹‰
class Player {
  constructor(name) {
    this.name = name;
  }
  // é™æ€
  static info() {
    console.log("çƒå‘˜ç±»");
  }
  // setter / getter å®šä¹‰
  get age() {
    return this._age;
  }
  set age(val) {
    this._age = val;
  }
}
Player.info();
let player = new Player("åº“é‡Œ");
player.age = 28;
console.log(player);

// ç±»ç»§æ‰¿
class WomenPlayer extends Player {
  constructor(name, country) {
    super(name);
    this.country = country;
  }
}
```

## æ•°ç»„å¾ªç¯(for...in) è¿­ä»£(for...of)

```js
// list ä¸ºå¯è¿­ä»£å¯¹è±¡ï¼Œå–å‡ºæ‰€æœ‰å±æ€§å’Œå€¼ï¼Œå¦‚æ•°ç»„ç±»å‹ Array æ·»åŠ å±æ€§ Array.prototype.Len = function() {}ï¼Œè¾“å‡º Len function() {}
let list = [10, 20, 30];
for (let val in list) console.log(val, list[val]);

// str ä¸ºå¯è¿­ä»£å¯¹è±¡
let str = "ä½ å¥½å•Š";
for (let val of str) console.log(val);

// map ä¸ºå¯è¿­ä»£å¯¹è±¡
let map = new Map();
map.set("JS", "Javascript");
map.set("PL", "Perl");
for (let [key, value] of map) console.log(key, value);
let it = map.values();

let tmp;
// å¯è¿­ä»£å¯¹è±¡ .next() ä¸ºå–ä¸‹ä¸€ä¸ªå¯¹è±¡
while ((tmp = it.next())) {
  if (tmp.done) break; // å¯è¿­ä»£å¯¹è±¡ .done ä¸ºæ˜¯å¦ç»“æŸï¼Œbool ç±»å‹
  console.log(tmp.value, tmp.done); // å½“å€¼å­˜åœ¨ï¼Œdone ä¸º false
}

class Player {
  constructor(list) {
    this.list = list;
  }
  // [Symbol.iterator] å¯å»ºç«‹å¯è¿­ä»£å¯¹è±¡
  [Symbol.iterator]() {
    let current = 0;
    let that = this;
    // å®ç° next() å’Œ done
    return {
      next() {
        return current < that.list.length
          ? { value: that.list[current++], done: false }
          : { done: true };
      },
    };
  }
}
let player = new Player(["Curry", "Harden", "LeBron"]);
for (let tmp of player) console.log(tmp);

// function* {} å’Œ yield å¯å»ºç«‹å¯è¿­ä»£æ–¹æ³•ï¼Œå³è¿­ä»£ç”Ÿæˆå™¨
function* myGenerator() {
  yield "ä¸€";
  yield "äºŒ";
}
for (let val of myGenerator()) console.log(val);

function* countdown(begin) {
  while (begin > 0) {
    yield begin--;
  }
}
for (let tmp of countdown(5)) console.log(tmp);

class MyList {
  constructor(list) {
    this.list = list;
    // function* {} å’Œ yield å¯å»ºç«‹å¯è¿­ä»£ç±»ï¼Œ[Symbol.iterator] å®ç°å•ä¸€ä¸‹æ ‡
    this[Symbol.iterator] = function* () {
      let current = 0;
      let that = this;
      while (current < that.list.length) {
        yield that.list[current++];
      }
    };
  }
}
let mylist = new MyList([100, 200, 300]);
for (let val of mylist) console.log(val);
```

## æ¨¡å—

- å‘½ä»¤ `node --experimental-modules main.mjs` è¿è¡Œ js æ¨¡å—

```js
// math.mjs æ–‡ä»¶
function add(x, y) {
  return x + y;
}
export { add }; // å¯¼å‡ºæ¨¡å—æ–¹æ³•

// Player.mjs æ–‡ä»¶
class Player {
  constructor(name) {
    this.name = name;
  }
  sayHelo() {
    console.log("Hello ${this.name}");
  }
}
export default Player; // å¯¼å‡ºæ¨¡å—ç±»

// main.mjs æ–‡ä»¶
import { add } from "./math"; // å¯¼å…¥æ¨¡å—æ–¹æ³•
import Player from "./Player"; // å¯¼å…¥æ¨¡å—ç±»
```

## å…¶ä»–

### è¿›åˆ¶è½¬æ¢

```js
console.log(0b11 === 3) // trueï¼Œ0b ä¸º 2 è¿›åˆ¶ï¼Œ0o ä¸º 8 è¿›åˆ¶ï¼Œ0x ä¸º 16 è¿›åˆ¶
console.log(10.toString(5)) // 5 è¿›åˆ¶è½¬æ¢ï¼ŒtoString() å¯ä»»æ„è¿›åˆ¶è½¬æ¢
```

### æ–‡å­—æ¨¡ç‰ˆ

```js
let name = 'Koma'
let str = markdown'ä½ å¥½ï¼Œ${name}ï¼ES6å¯æ¢è¡Œ'
function markdown (formats, ...args) {
    console.log(formats) // formats ä¸ºæ–‡å­—æ¨¡æ¿æ®µåˆ—è¡¨
    console.log(args) // args ä¸ºæ–‡å­—å‚æ•°åˆ—è¡¨
    let result = '# ä¿¡æ¯æ ‡é¢˜\n'
    for (let i = 0; i < formats.length; i++) result += formats[i] + '**' + (args[i] || '') + '**'
    return result
}
```

### symbol()

```js
let obj = {};
obj[Symbol("mySymbol")] = "helo"; // Symbol ä½œä¸ºå±æ€§
console.log(obj);

const myKey = Symbol(); // Symbol ä½œä¸ºå¸¸é‡

class User {
  constructor(key, name) {
    this[myKey] = key; // Symbol ä½œä¸ºåŠéšè—å±æ€§
    this.name = name;
  }
  checkKey(key) {
    return this[myKey] === key;
  }
}

let user = new User(123, "Curry");
console.log(user.name, user[myKey]);
console.log(user.checkKey(123)); // true
console.log(Object.keys(user)); // [ 'name' ]
console.log(JSON.stringify(user)); // { 'name': 'Curry' }
```

### å‡½æ•°æ„é€ å™¨

```js
const add = new Function("a", "b", "return a+b");
console.log(add(10, 20));
const helo = new Function("name", "return 'helo '+name+'.'");
console.log(helo("koma"));
```

### åŠ¨æ€ç»‘å®šå±æ€§

```js
const book = {
  title: "I like javascript.",
  price: 50,
};
with (book) {
  console.log("ä¹¦åï¼š", title);
  console.log("ä»·æ ¼ï¼š", price);
}
```

### å‡½æ•°çš„è°ƒç”¨å †æ ˆ

```js
function func1() {
  console.log("func1():", arguments.callee.caller);
}
function func2() {
  func1();
}
func2();
```

### void æ— æ•ˆæ“ä½œç¬¦

```js
console.log(void 1);
console.log(void true);
console.log(void false);
console.log(void {});
console.log(void undefined);

if (void 1) {
  console.log("yes");
} else {
  console.log("no");
}
```
