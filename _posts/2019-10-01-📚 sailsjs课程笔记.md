---
layout: post
title: ğŸ“š sailsjsè¯¾ç¨‹ç¬”è®°
img: header_post.jpg
tags: [sailsjs, ğŸ“š]
---

- [æ§åˆ¶å™¨ åµŒå…¥å¼ç­–ç•¥ å®šåˆ¶è·¯ç”±](#æ§åˆ¶å™¨-åµŒå…¥å¼ç­–ç•¥-å®šåˆ¶è·¯ç”±)
- [api æœåŠ¡ æ•°æ®åº“è¿æ¥(mongoDB)](#api-æœåŠ¡-æ•°æ®åº“è¿æ¥mongodb)
- [éƒ¨ç½² ç›‘è§†](#éƒ¨ç½²-ç›‘è§†)

---

<!-- - æ§åˆ¶å™¨ åµŒå…¥å¼ç­–ç•¥ å®šåˆ¶è·¯ç”±
- api æœåŠ¡ æ•°æ®åº“è¿æ¥(mongoDB)
- éƒ¨ç½² ç›‘è§† -->

# æ§åˆ¶å™¨ åµŒå…¥å¼ç­–ç•¥ å®šåˆ¶è·¯ç”±

```bash
$ npm install -g sails@0.12.14

$ sails new myweb # æ–°å»º
$ cd myweb
$ sails lift # è¿è¡Œï¼Œåœ¨ http://127.0.0.1:1337 ä¸­æŸ¥çœ‹

# ç”Ÿæˆæ§åˆ¶å™¨æ–‡ä»¶ api/controllers/TestController.js
$ sails generate controller test
```

```html
<!-- views/mypage.ejsæ–‡ä»¶ï¼Œç›®æ ‡ç½‘é¡µ
views ä¸º ejs æ¨¡æ¿ç›®å½•ï¼Œå« 403.ejsã€404.ejsã€500.ejsã€homepage.ejsã€layout.ejs ç­‰ -->
<a href="http://komavideo.com" class="btn btn-primary">MyPage</a>

<!-- views/bootstraplayout.ejs æ–‡ä»¶ï¼Œæ¨¡æ¿ -->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Bootstrap 4 Layout</title>
    <link rel="stylesheet" href="/css/bootstrap.min.css" />
  </head>
  <body>
    <%- body %>
  </body>
</html>
```

```js
// api/controllers/TestController.js æ–‡ä»¶
// api/controllers ä¸ºæ§åˆ¶å™¨ç›®å½•ï¼Œæ˜ å°„è·¯ç”± url
module.exports = {
  go: function (req, res) {
    // æ˜ å°„åˆ° http://127.0.0.1:1337/test/go
    res.ok(); // è¿”å› 200ï¼Œå¯¹åº” responses/ok.jsï¼Œapi/responses è‡ªå®šä¹‰ http æ–‡ä»¶
    //res.forbidden();   // è¿”å› 403 æ‹’ç»è®¿é—®ï¼Œå¯¹åº” responses/forbidden.js å’Œ views/403.ejs
    //res.notFound();    // è¿”å› 404 æ–‡ä»¶æ²¡æ‰¾åˆ°ï¼Œå¯¹åº” responses/notFound.js å’Œ views/404.ejs
    //res.serverError(); // è¿”å› 500 æœåŠ¡å™¨é”™è¯¯ï¼Œå¯¹åº” responses/serverError.js å’Œ views/500.ejs
  },

  mypage: function (req, res) {
    // æ˜ å°„åˆ° http://127.0.0.1:1337/test/mypage
    res.view("mypage", { layout: "bootstraplayout" }); // å¯¹åº” views/mypage.ejs ç½‘é¡µå’Œ views/bootstraplayout.ejs æ¨¡æ¿
  },
  page1: function (req, res) {
    res.send("page1");
  },
  page2: function (req, res) {
    res.send("page2");
  },
};

// api/policies/accessLog.js æ–‡ä»¶
// api/policies ä¸ºè®¿é—®ç­–ç•¥ç›®å½•
module.exports = function (req, res, next) {
  console.info(req.method, req.path); // åµŒå…¥å¼ç­–ç•¥ï¼Œå³è·¯ç”±ç»‘å®šåŠŸèƒ½ï¼Œinfo() ä¸ºè·¯ç”±æ·»åŠ æ—¥å¿—åŠŸèƒ½
  return next();
};

// config/policies.js æ–‡ä»¶ï¼Œç­–ç•¥é…ç½®
module.exports.policies = {
  //æ³¨å†Œç­–ç•¥
  "*": ["accesslog"],
  "usr/edit/profile": ["isAuthorized"],
};

// config/routes.js æ–‡ä»¶ï¼Œè·¯ç”±é…ç½®
module.exports.routes = {
  "/": { view: "homepage" },
  // å®šåˆ¶è·¯ç”±ï¼Œ/page1 è®¿é—®é»˜è®¤é…ç½®ä¸º /test/page1
  "GET /page1": "TestController.page1",
  // å®šåˆ¶è·¯ç”±ï¼Œ/page2 è®¿é—®é»˜è®¤é…ç½®ä¸º /test/page2ï¼Œå¹¶è§¦å‘ç­–ç•¥
  "GET /page2": [
    { policy: "accessLog" },
    { controller: "test", action: "page2" },
  ],
};
```

# api æœåŠ¡ æ•°æ®åº“è¿æ¥(mongoDB)

```bash
# ç”Ÿæˆ api æœåŠ¡æ–‡ä»¶ api/controllers/UserController.js(é»˜è®¤ apiï¼Œæ— éœ€ç¼–ç ) å’Œ api/models/User.js
$ sails generate api User

$ npm install sails-mongo@0.12.3 --save --save-exact # å®‰è£… MongoDB é©±åŠ¨åº“
```

```js
// api/models/User.js æ–‡ä»¶
// api/models ä¸ºæ•°æ®åº“å®ä½“æ¨¡å‹ç›®å½•
module.exports = {
  attributes: {
    username: { type: "string" },
    address: { type: "string" },
  },
};

// config/connections.js æ–‡ä»¶ï¼Œæ•°æ®åº“è¿æ¥é…ç½®ï¼Œå«å¸¸ç”¨æ•°æ®åº“é…ç½®æ¨¡æ¿
module.exports.connections = {
  localDiskDb: { adapter: "sails-disk" }, // é»˜è®¤æœ¬åœ°æ•°æ®åº“
  mydb: {
    adapter: "sails-mongo",
    host: "192.168.11.18",
    port: 27017,
    user: "username", // å¯é€‰
    password: "password", // å¯é€‰
    database: "mydb",
  },
};

// config/models.js æ–‡ä»¶ï¼Œæ•°æ®åº“æ¨¡å‹é…ç½®
module.exports.models = {
  connection: "mydb", // é»˜è®¤ localDiskDb
  migrate: "alter", // æ ¹æ® api å®æ—¶æ›´æ–°æ•°æ®åº“
};
```

- `GET /user` æ˜ å°„åˆ° UserController `.find`ï¼ŒæŸ¥è¯¢æ‰€æœ‰æ•°æ®ï¼Œè°ƒç”¨ `http://127.0.0.1:1337/user` æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·
- `GET /user/:id` æ˜ å°„åˆ° UserController `.findOne`ï¼Œæ ¹æ® id æŸ¥æ‰¾æ•°æ®ï¼Œè°ƒç”¨ `http://127.0.0.1:1337/user/1` æŸ¥è¯¢ id ä¸º 1 çš„ç”¨æˆ·
- `POST /user` æ˜ å°„åˆ° UserController `.create`ï¼Œæ·»åŠ æ•°æ®ï¼Œè°ƒç”¨ `http://127.0.0.1:1337/user/create?username=koma&address=china` æ·»åŠ ç”¨æˆ·
- `PUT /user/:id` æ˜ å°„åˆ° UserController `.update`ï¼Œæ ¹æ® id æ›´æ–°æ•°æ®ï¼Œåœ¨ `postman` ä¸­é€‰æ‹© `PUT` æ¨¡å¼ï¼Œè°ƒç”¨ `http://127.0.0.1:1337/user/1`ï¼Œåœ¨ body ä¸­æ·»åŠ å‚æ•°ï¼Œå¦‚æŠŠ address å€¼æ”¹ä¸º japan
- `DELETE /user/:id` æ˜ å°„åˆ° UserController `.destroy`ï¼Œæ ¹æ® id åˆ é™¤æ•°æ®ï¼Œåœ¨ `postman` ä¸­é€‰æ‹© `DELETE` æ¨¡å¼ï¼Œè°ƒç”¨ `http://127.0.0.1:1337/user/2`

# éƒ¨ç½² ç›‘è§†

```js
// config/env/production.js æ–‡ä»¶ï¼Œç”Ÿäº§ç¯å¢ƒå®‰å…¨é…ç½®
module.exports = {
  blueprints: {
    actions: true, // è‡ªåŠ¨è·¯ç”±ï¼Œé…åˆå®‰å…¨ url ç›‘è§†å’Œå­˜å‚¨ç­–ç•¥
    rest: false, // å¯ä¸º true
    shortcuts: false, // éœ€ä¸º false
  },
  cors: {
    // è·¨åŸŸèµ„æº
    allRoutes: false, // å…³é—­å…¨è·¯ç”±çš„è·¨åŸŸå­˜å‚¨
    origin: "http://a.com,https://b.com", // å…è®¸å­˜å‚¨çš„åŸŸå
    credentials: true, // éœ€è¦ cookies éªŒè¯
  },
  csrf: true, // è·¨åŸŸè¯·æ±‚
};
```
